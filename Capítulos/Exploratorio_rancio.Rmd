---
title: "2¬∫ An√°lisis Inform√°tica"
author: "Pablo Parrilla Ca√±adas"
date: "2025-04-07"
output: html_document
---


```{r}
library(dplyr)
library(ggplot2)
library(reshape2)
load("../Datos/Cap√≠tulos/Preprocesado.RData")
```


```{r}
sum(table(format(as.POSIXct(abandono$fecha_mas_frecuente[abandono$abandono == 1]), "%Y %m")))
```

Vemos que las fechas m√°s frecuentes son junio, 

```{r}
table(abandono$abandono)
table(format(as.POSIXct(abandono$baja_fecha[abandono$abandono == 1]), "%Y %m"))

```


Las fechas m√°s frecuentes son al empezar y terminar el curso, septiembre y julio respectivamente. 

Inform√°tica 0fecf9247f3d



# Exploratorio digital


```{r}
lineas_multiple=poliformat_enterolineas_multiple <- function(df, columnas, titulo) {
  # Verificar si la columna "abandono" existe
  if (!"abandono" %in% names(df)) {
    stop("La columna 'abandono' no existe en el dataframe.")
  }

  # Convertir columnas num√©ricas a nombres si hace falta
  if (is.numeric(columnas)) {
    columnas <- names(df)[columnas]
  }

  # Reemplazar NA por 0
  df$abandono <- ifelse(is.na(df$abandono), 0, df$abandono)

  # Seleccionar columnas
  df_seleccionado <- df[, c(columnas, "abandono"), drop = FALSE]
  df_seleccionado <- df_seleccionado[sapply(df_seleccionado, is.numeric)]

  df_valores <- df_seleccionado[, setdiff(names(df_seleccionado), "abandono"), drop = FALSE]
  if (ncol(df_valores) == 0) {
    message("No hay columnas num√©ricas en la selecci√≥n.")
    return(NULL)
  }

  df_valores$ID <- 1:nrow(df_valores)
  df_valores$abandono <- df_seleccionado$abandono

  df_melt <- reshape2::melt(df_valores, id.vars = c("ID", "abandono"),
                            variable.name = "Variable", value.name = "Valor")
  
  df_melt$Variable <- factor(df_melt$Variable, levels = columnas)

  df_negro <- df_melt[df_melt$abandono == 0, ]
  df_rojo  <- df_melt[df_melt$abandono == 1, ]
  
  df_rojo=unique(df_rojo)
  df_negro=unique(df_negro)

  ggplot() +
    geom_line(data = df_negro, aes(x = Variable, y = Valor, group = ID),
              color = "black", alpha = 0.3, size = 0.5) +
    geom_line(data = df_rojo, aes(x = Variable, y = Valor, group = ID),
              color = "red", alpha = 0.8, size = 0.7) +
    labs(title = paste0("Gr√°fico de L√≠neas: ", titulo),
         x = "Variables (Columnas)", y = "Valores") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())
}


lineas_multiple(poliformat,c(3:9),"Eventos de Poliformat x estudiante")
lineas_multiple(poliformat,c(10:16),"Sesiones iniciadas en Poliformat x estudiante")
lineas_multiple(poliformat,c(17:23),"Visitas a Poliformat x estudiante")
lineas_multiple(poliformat,c(24:30),"Minutos Totales x estudiante")
lineas_multiple(poliformat,c(32:37),"Conexiones al wifi x estudiante")
lineas_multiple(poliformat,c(39:44),"Recursos abiertos x estudiante")
lineas_multiple(poliformat,c(45:51),"Eventos de recursos x estudiante")
lineas_multiple(poliformat,c(52:56),"Tareas entregadas x estudiante")
lineas_multiple(poliformat,c(57:61),"Tests entregados x estudiante")
```

```{r}
lineas_multiple(sociodemografia,c(21:27),"Wifi x estudiante")
colnames(sociodemografia)

```
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(forcats)

graficos_barras_por_variable <- function(df, columnas) {
  # Asegurar que abandono es factor para colorear
  df$abandono <- factor(ifelse(is.na(df$abandono), 0, df$abandono),
                        levels = c(0, 1), labels = c("No abandona", "Abandona"))
  
  # Si columnas son num√©ricas (√≠ndices), convertir a nombres
  if (is.numeric(columnas)) {
    columnas <- names(df)[columnas]
  }
  
  for (col in columnas) {
    variable <- df[[col]]
    
    # Si es character ‚Üí factor con NA expl√≠cito
    if (is.character(variable)) {
      variable <- fct_explicit_na(as.factor(variable), na_level = "Desconocido")
    
    # Si es num√©rica
    } else if (is.numeric(variable)) {
      if (all(is.na(variable))) {
        variable <- factor(rep("0", nrow(df)))  # Todos NA
      } else if (n_distinct(variable, na.rm = TRUE) > 15) {
        next  # Demasiados valores √∫nicos ‚Üí ignorar
      } else {
        variable <- fct_explicit_na(as.factor(variable), na_level = "Desconocido")
      }
    
    # Otras clases (logical, etc.)
    } else {
      variable <- fct_explicit_na(as.factor(variable), na_level = "Desconocido")
    }
    
    # Crear data frame temporal para graficar
    df_plot <- data.frame(Variable = variable, Abandono = df$abandono)
    
    # Graficar
    print(
      ggplot(df_plot, aes(x = Variable, fill = Abandono)) +
        geom_bar(position = "dodge") +
        labs(
          title = paste("Frecuencia por categor√≠a -", col),
          x = col,
          y = "Frecuencia",
          fill = "Abandono"
        ) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    )
  }
}

graficos_barras_por_variable(sociodemografia,c(4:10,13:20))
colnames(sociodemografia)
```


```{r}
library(tidyr)
library(ggplot2)

df_long <- sociodemografia %>%
  pivot_longer(cols = c(nota10, nota14), names_to = "variable", values_to = "valor")

a=ggplot(df_long, aes(x = valor, fill = variable)) +
  geom_density(alpha = 0.5) +
  labs(title = "Densidad de nota10 y nota14", x = "Valor", y = "Densidad") +
  theme_minimal()



```

```{r}

df_long <- demograf√≠a_inf %>%
  mutate(nota14 = (nota14 / 14) * 10) %>%  # Escalar nota14 sobre 10
  pivot_longer(cols = c(nota10, nota14), names_to = "variable", values_to = "valor")

ggplot(df_long, aes(x = valor, fill = variable)) +
  geom_density(alpha = 0.5) +
  labs(title = "Densidad de nota10 y nota14 (escalada)", x = "Valor sobre 10", y = "Densidad") +
  theme_minimal()


```

Cu√°nta gente se ha cambiado de carrera?

```{r}

head(demograf√≠a)

unique(dataset_ordenado[,"dni_hash"])


```

Aparentemente ninguno.

```{r}
library(corrplot)



```


```{r size=7}
library(dplyr)
library(fastDummies)
library(corrplot)

# Paso 1: Copia del dataframe para no tocar el original
df <- demograf√≠a_inf[,c("nacionalitat",
  "data_nac", "sexe", "alta_universitat", "prov_origen", "anyo_ingreso", "tipo_ingreso",
  "nota10", "nota14", "estudios_p", "estudios_m", "dedicacion",
  "desplazado", "discapacidad", "becado", "preferencia_seleccion","n_wifi_days_2024_7", "n_wifi_days_2024_8", "n_wifi_days_2024_9", "n_wifi_days_2024_10",
  "n_wifi_days_2024_11", "n_wifi_days_2024_12", "n_wifi_days_2025_1","abandono")]

# Paso 2: Convertir variables character a factor (si no lo son ya)
df <- df %>%
  mutate(across(where(is.character), as.factor))

# Paso 3: Convertir las ordinales manualmente (ejemplo)
# ‚ö†Ô∏è Asegurate de que los niveles est√©n en el orden correcto

# Paso 4: Crear dummies para variables categ√≥ricas nominales
df_dummies <- fastDummies::dummy_cols(df, remove_selected_columns = TRUE)

# Paso 5: Seleccionar solo columnas num√©ricas para correlaci√≥n
df_numeric <- df_dummies %>% select(where(is.numeric))

# Paso 6: Matriz de correlaci√≥n
cor_mat <- cor(df_numeric, use = "pairwise.complete.obs")

library(corrplot)

corrplot(cor_mat,
         method = "color",          # solo color
         type = "upper",            # parte superior
         tl.cex = 0.7,              # tama√±o etiquetas
         tl.col = "black",          # color texto etiquetas
         addCoef.col = NA,          # üî• esto quita los numeritos
         number.cex = 0,            # adicional para evitar que salgan
         cl.cex = 0.7,              # tama√±o de la leyenda lateral
         na.label = " ",            # sin "?" en los NA
         col = colorRampPalette(c("blue", "white", "red"))(200))  # colores

library(reshape2)
library(ggplot2)

melted_cor <- melt(cor_mat)

ggplot(melted_cor, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.text.y = element_text(size = 6),
        panel.grid = element_blank()) +
  labs(title = "Heatmap de correlaci√≥n",
       x = "", y = "", fill = "Correlaci√≥n")

```

```{r}
# Paquetes necesarios
library(dplyr)
library(ggplot2)
library(rcompanion)

# Variables que quer√©s usar
vars_usar <- c(
  "nacionalitat", "data_nac", "sexe", "alta_universitat", "prov_origen", 
  "anyo_ingreso", "tipo_ingreso", "nota10", "nota14", "estudios_p", 
  "estudios_m", "dedicacion", "desplazado", "discapacidad", "becado", 
  "preferencia_seleccion", "n_wifi_days_2024_7", "n_wifi_days_2024_8", 
  "n_wifi_days_2024_9", "n_wifi_days_2024_10", "n_wifi_days_2024_11", 
  "n_wifi_days_2024_12", "n_wifi_days_2025_1"
)

# Asegurarse de que abandono es num√©rica binaria (0/1)
demograf√≠a_inf$abandono <- as.numeric(as.factor(demograf√≠a_inf$abandono)) - 1

# Filtrar solo variables seleccionadas + abandono
df_sel <- demograf√≠a_inf[, c("abandono", vars_usar)]

# üîÅ TRANSFORMACIONES MANUALES

# 1. sexe: "V" ‚Üí 1, "M" ‚Üí 0
df_sel$sexe <- ifelse(df_sel$sexe == "V", 1,
                      ifelse(df_sel$sexe == "M", 0, NA))

# 2. nacionalitat: "E" ‚Üí 1, "XXX" ‚Üí 0
df_sel$nacionalitat <- ifelse(df_sel$nacionalitat == "E", 1,
                              ifelse(df_sel$nacionalitat == "XXX", 0, NA))

# Separar num√©ricas y categ√≥ricas (post-transformaci√≥n)
num_vars <- vars_usar[sapply(df_sel[, vars_usar], is.numeric)]
cat_vars <- vars_usar[sapply(df_sel[, vars_usar], function(x) is.factor(x) || is.character(x))]

# A√±adir sexe y nacionalitat a las num√©ricas manualmente (ya las convertimos)
num_vars <- union(num_vars, c("sexe", "nacionalitat"))
cat_vars <- setdiff(cat_vars, c("sexe", "nacionalitat"))

# Inicializar resultados
resultados <- data.frame(variable = character(),
                         correlacion = numeric(),
                         tipo = character(),
                         stringsAsFactors = FALSE)

# üìà Correlaciones num√©ricas (Pearson)
for (var in num_vars) {
  valor <- suppressWarnings(cor(df_sel$abandono, df_sel[[var]], use = "complete.obs"))
  resultados <- rbind(resultados, data.frame(variable = var, correlacion = valor, tipo = "Num√©rica"))
}

# üìä Categ√≥ricas (Cram√©r‚Äôs V)
for (var in cat_vars) {
  x <- as.factor(df_sel$abandono)
  y <- as.factor(df_sel[[var]])
  
  # Solo usar pares completos
  df_temp <- data.frame(x = x, y = y)
  df_temp <- df_temp[complete.cases(df_temp), ]
  
  v <- tryCatch({
    if (nlevels(df_temp$x) >= 2 && nlevels(df_temp$y) >= 2) {
      cramerV(df_temp$x, df_temp$y, bias.correct = TRUE)
    } else {
      NA
    }
  }, error = function(e) NA)
  
  resultados <- rbind(resultados, data.frame(variable = var, correlacion = v, tipo = "Categ√≥rica"))
}

# üé® Gr√°fico
ggplot(resultados, aes(x = reorder(variable, correlacion), y = correlacion, fill = tipo)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_manual(values = c("Num√©rica" = "steelblue", "Categ√≥rica" = "orange")) +
  theme_minimal() +
  labs(title = "Correlaci√≥n de variables con 'abandono'",
       x = "Variable",
       y = "Correlaci√≥n (Pearson o Cram√©r's V)",
       fill = "Tipo de variable")


```

